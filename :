class DockerMachineDriverCloudstack < Formula
  desc "Docker Machine generic CloudStack driver"
  homepage "https://github.com/atsaki/docker-machine-driver-cloudstack"
  url "https://github.com/atsaki/docker-machine-driver-cloudstack/archive/v0.1.2.tar.gz"
  version "v0.1.2"
  sha256 "82c54f8407ad77cc2c845873e24a6d1ffc86a30297f5d85c492d2ea48770e481"
  head "https://github.com/atsaki/docker-machine-driver-cloudstack.git"

  depends_on "go" => :build
  depends_on "glide" => :build
  depends_on "docker-machine"

  go_resource "github.com/mitchellh/gox" do
    url "https://github.com/mitchellh/gox.git",
        :revision => "a5a468f84d74eb51ece602cb113edeb37167912f"
  end

  # gox dependency
  go_resource "github.com/mitchellh/iochan" do
    url "https://github.com/mitchellh/iochan.git",
        :revision => "87b45ffd0e9581375c491fef3d32130bb15c5bd7"
  end

  def install
    ENV["GOPATH"] = buildpath
    ENV.append_path "PATH", buildpath

    mkdir_p buildpath/"src/github.com/atsaki/"
    ln_sf buildpath, buildpath/"src/github.com/atsaki/docker-machine-driver-cloudstack"
    Language::Go.stage_deps resources, buildpath/"src"
    mkdir_p buildpath/"bin"

    cd "src/github.com/mitchellh/gox" do
      system "go", "build"
      buildpath.install "gox"
    end

    cd "src/github.com/atsaki/docker-machine-driver-cloudstack" do
      system "TARGET_OS=darwin", "make"
      bin.install "dist/docker-machine-driver-cloudstack_"
    end
  end

  # test do
  #   assert_match "parallels-memory", shell_output("docker-machine create -d parallels -h")
  # end
end
